name: Monitor Dependency Updates

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check npm updates
        id: npm-updates
        run: |
          npm install -g npm-check-updates
          echo "updates=$(ncu --packageFile package.json --json 2>/dev/null || echo '{}')" >> $GITHUB_OUTPUT

      - name: Check Tauri updates
        id: tauri-updates
        run: |
          LATEST_TAURI=$(curl -s https://api.github.com/repos/tauri-apps/tauri/releases/latest | jq -r '.tag_name')
          echo "latest=$LATEST_TAURI" >> $GITHUB_OUTPUT

      - name: Check for security advisories
        id: security
        run: |
          npm audit --json > /tmp/npm-audit.json 2>/dev/null || echo '{"vulnerabilities":{}}' > /tmp/npm-audit.json
          CRITICAL=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "critical" or .value.severity == "high")] | length' /tmp/npm-audit.json 2>/dev/null || echo "0")
          echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT

      - name: Create issue if updates available
        if: steps.npm-updates.outputs.updates != '{}' || steps.tauri-updates.outputs.latest != ''
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: |
            [DEPENDENCY UPDATE] Updates available - ${{ 
              steps.tauri-updates.outputs.latest != '' 
              && 'Tauri ' || '' 
            }}${{ 
              steps.npm-updates.outputs.updates != '{}' 
              && 'npm packages' || '' 
            }}
          content-filepath: /tmp/update-report.md
          labels: |
            dependencies
            enhancement
            ${{ steps.security.outputs.critical_count > 0 && 'priority-high' || 'priority-medium' }}

      - name: Generate update report
        run: |
          cat > /tmp/update-report.md << EOF
          ## Dependency Update Report
          
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### Tauri Updates
          
          Latest: \`${{ steps.tauri-updates.outputs.latest }}\`
          
          ### npm Package Updates
          
          \`\`\`json
          ${{ steps.npm-updates.outputs.updates }}
          \`\`\`
          
          ### Security Advisories
          
          **Critical/High Vulnerabilities:** ${{ steps.security.outputs.critical_count }}
          
          ### Recommended Actions
          
          1. **If security vulnerabilities found:** Run \`npm audit fix\` immediately
          2. **If Tauri update available:** Review changelog for breaking changes
          3. **If major version updates:** Create separate PR for each major update
          4. **If minor/patch updates:** Can batch multiple updates in single PR
          
          ---
          
          *Generated by Release Monitoring Workflow*
          EOF
